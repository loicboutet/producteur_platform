<div class="max-w-2xl mx-auto">
  <div class="bg-white shadow rounded-lg p-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">ðŸ’³ Complete Payment</h1>

    <!-- Order Summary -->
    <div class="border rounded-lg p-4 mb-6 bg-gray-50">
      <h2 class="font-semibold text-gray-900 mb-3">Order Summary</h2>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Producers:</span>
          <span class="font-medium"><%= @order_group.producers_count %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Total Items:</span>
          <span class="font-medium"><%= @order_group.orders.sum(:quantity) %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Platform Fee:</span>
          <span class="font-medium"><%= @order_group.formatted_platform_fee %></span>
        </div>
        <div class="border-t pt-2 flex justify-between font-bold text-lg">
          <span>Total:</span>
          <span class="text-green-600"><%= @order_group.formatted_total %></span>
        </div>
      </div>
    </div>

    <!-- Multi-Split Info -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
      <h3 class="font-semibold text-blue-900 mb-2">ðŸ’° Multi-Producer Split Payment</h3>
      <div class="space-y-1 text-sm text-blue-800">
        <% @order_group.orders.group_by(&:producer).each do |producer, orders| %>
          <p>â€¢ <%= producer.name %>: <%= number_to_currency(orders.sum(&:producer_amount), unit: "â‚¬") %></p>
        <% end %>
        <p class="text-xs mt-2 text-blue-600">All splits happen automatically via Stripe! ðŸŽ‰</p>
      </div>
    </div>

    <!-- Payment Form -->
    <form id="payment-form" class="space-y-6">
      <div>
        <label for="card-element" class="block text-sm font-medium text-gray-700 mb-2">
          Credit or Debit Card
        </label>
        <div id="card-element" class="p-4 border border-gray-300 rounded-md bg-white">
          <!-- Stripe Card Element will be inserted here -->
        </div>
        <div id="card-errors" class="mt-2 text-sm text-red-600"></div>
      </div>

      <div class="bg-gray-50 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="h-5 w-5 text-gray-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
          <p class="ml-3 text-sm text-gray-600">
            Secure payment processed by Stripe. Your card details are never stored on our servers.
          </p>
        </div>
      </div>

      <button type="submit" id="submit-button" class="w-full px-6 py-3 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
        <span id="button-text">Pay <%= @order_group.formatted_total %> (Multi-Split)</span>
        <span id="spinner" class="hidden">Processing...</span>
      </button>
    </form>

    <div class="mt-4 text-center">
      <%= link_to "Cancel", cart_path, class: "text-gray-600 hover:text-gray-900" %>
    </div>
  </div>

  <!-- Test Card Info -->
  <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
    <h3 class="font-semibold text-yellow-900 mb-2">ðŸ§ª Test Mode - Use these test cards:</h3>
    <div class="text-sm text-yellow-800 space-y-1">
      <p><strong>Success:</strong> 4242 4242 4242 4242</p>
      <p><strong>Declined:</strong> 4000 0000 0000 0002</p>
      <p>Use any future expiry date and any 3-digit CVC</p>
    </div>
  </div>
</div>

<%= javascript_tag nonce: true do %>
  (function() {
    console.log('Payment script loaded');
    
    // Fonction pour charger Stripe
    function loadStripe() {
      return new Promise((resolve, reject) => {
        if (typeof Stripe !== 'undefined') {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://js.stripe.com/v3/';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    // Initialiser le paiement
    async function initPayment() {
      try {
        await loadStripe();
        console.log('Stripe.js loaded successfully');
        
        const stripe = Stripe('<%= @stripe_publishable_key %>');
        const elements = stripe.elements();
        
        console.log('Stripe initialized');
        
        // Create card element
        const cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#32325d',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
              '::placeholder': {
                color: '#aab7c4'
              }
            },
            invalid: {
              color: '#fa755a',
              iconColor: '#fa755a'
            }
          }
        });
        
        // Mount the card element
        const cardElementContainer = document.getElementById('card-element');
        if (cardElementContainer) {
          cardElement.mount('#card-element');
          console.log('Card element mounted successfully');
        } else {
          console.error('Card element container not found!');
          return;
        }
        
        // Handle real-time validation errors
        cardElement.on('change', function(event) {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });
        
        // Handle form submission
        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        
        if (form) {
          form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            console.log('Form submitted');
            
            submitButton.disabled = true;
            buttonText.classList.add('hidden');
            spinner.classList.remove('hidden');
            
            try {
              const {error, paymentIntent} = await stripe.confirmCardPayment(
                '<%= @payment_intent.client_secret %>',
                {
                  payment_method: {
                    card: cardElement
                  }
                }
              );
              
              if (error) {
                console.error('Payment error:', error);
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = error.message;
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
              } else {
                console.log('Payment succeeded:', paymentIntent);
                if (paymentIntent.status === 'succeeded') {
                  console.log('Redirecting to confirmation...');
                  window.location.href = '<%= confirm_payment_checkout_path(order_group_id: @order_group.id) %>';
                }
              }
            } catch (error) {
              console.error('Unexpected payment error:', error);
              const errorElement = document.getElementById('card-errors');
              errorElement.textContent = 'An unexpected error occurred. Please try again.';
              submitButton.disabled = false;
              buttonText.classList.remove('hidden');
              spinner.classList.add('hidden');
            }
          });
        } else {
          console.error('Payment form not found!');
        }
      } catch (error) {
        console.error('Error initializing payment:', error);
      }
    }
    
    // Lancer l'initialisation
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPayment);
    } else {
      initPayment();
    }
  })();
<% end %>
